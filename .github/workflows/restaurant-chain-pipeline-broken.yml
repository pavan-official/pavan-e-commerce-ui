# ğŸ½ï¸ **Restaurant Chain CI/CD Pipeline - ADVANCED FEATURES**
# This is your "Central Kitchen" with advanced security and monitoring
# Interview Story: "This is like our central kitchen with food safety inspections, quality monitoring, and automated alerts"

name: ğŸ½ï¸ Restaurant Chain Pipeline (Advanced)

# ğŸ¯ **When does the central kitchen start working?**
# Interview Story: "Every time a chef adds a new recipe to our recipe book"
on:
    push:
        branches: [main, completed, develop]
    pull_request:
        branches: [main]
    # ğŸ·ï¸ **Automated Versioning Trigger**
    # Interview Story: "When we tag a recipe with a version number, it triggers a special production deployment"
    tags:
        - 'v*.*.*'  # Triggers on version tags like v1.0.0, v1.2.3

# ğŸ­ **Central Kitchen Environment**
# Interview Story: "This sets up our central kitchen with all the tools we need"
env:
    # Docker Hub Configuration
    DOCKER_HUB_REGISTRY: docker.io
    DOCKER_HUB_REPOSITORY: pavandoc1990/ecommerce-restaurant
    IMAGE_TAG: ${{ github.sha }}
    IMAGE_TAG_LATEST: latest
    IMAGE_TAG_VERSION: ${{ github.ref_name }}
    
    # Security Configuration
    TRIVY_CACHE_DIR: .trivycache
    TRIVY_DB_REPOSITORY: ghcr.io/aquasecurity/trivy-db
    TRIVY_JAVA_DB_REPOSITORY: ghcr.io/aquasecurity/trivy-java-db
    
    # Kubernetes Configuration
    KUBERNETES_NAMESPACE: restaurant-production

jobs:
    # ğŸ” **RECIPE VALIDATION STATION**
    # Interview Story: "This is where we check if the recipe is well-formatted and safe"
    recipe-validation:
        name: ğŸ” Recipe Validation
        runs-on: ubuntu-latest

        steps:
            - name: ğŸ“ Get Recipe from Recipe Book
              uses: actions/checkout@v4
              # Interview Story: "This gets the latest recipe from our master recipe book (Git)"

            - name: ğŸ³ Setup Kitchen Tools (Node.js)
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
              # Interview Story: "This sets up all the kitchen tools (Node.js, npm) we need"

            - name: ğŸ“‹ Install Dependencies
              run: |
                  cd client
                  npm install
              # Interview Story: "This installs all the ingredients (dependencies) we need"

            - name: ğŸ“‹ Check Recipe Format (Linting)
              run: |
                  cd client
                  npm run lint
              # Interview Story: "This checks if the recipe follows proper cooking standards (linting)"

            - name: ğŸ§ª Taste Test Recipe (Unit Tests)
              run: |
                  cd client
                  npm run test
              # Interview Story: "This tests if the recipe actually works (unit tests)"

            - name: ğŸ”’ Safety Check (Security Audit)
              run: |
                  cd client
                  npm audit --audit-level moderate
              # Interview Story: "This checks for any dangerous ingredients (security vulnerabilities)"
              continue-on-error: true

    # ğŸ”’ **SECURITY INSPECTION STATION**
    # Interview Story: "This is where we perform deep security inspections on our packaged meals"
    security-inspection:
        name: ğŸ”’ Security Inspection
        runs-on: ubuntu-latest
        needs: recipe-validation

        steps:
            - name: ğŸ“ Get Recipe from Recipe Book
              uses: actions/checkout@v4

            - name: ğŸ³ Setup Kitchen Tools (Node.js)
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: ğŸ“‹ Install Dependencies
              run: |
                  cd client
                  npm install

            - name: ğŸ—ï¸ Build Recipe
              run: |
                  cd client
                  npm run build
              # Interview Story: "This prepares the recipe for security inspection"

            - name: ğŸ³ Build Docker Image for Security Scan
              run: |
                  cd client
                  echo "ğŸ½ï¸ Building Docker image for security inspection..."
                  docker build -t ${{ env.DOCKER_HUB_REPOSITORY }}:${{ env.IMAGE_TAG }} .
              # Interview Story: "This packages the recipe for security inspection"

            - name: ğŸ”’ Run Trivy Security Scan
              uses: aquasecurity/trivy-action@master
              with:
                  image-ref: ${{ env.DOCKER_HUB_REPOSITORY }}:${{ env.IMAGE_TAG }}
                  format: 'sarif'
                  output: 'trivy-results.sarif'
                  severity: 'CRITICAL,HIGH,MEDIUM'
              # Interview Story: "This performs a deep security inspection of our packaged meal"

            - name: ğŸ“Š Upload Trivy Scan Results
              uses: github/codeql-action/upload-sarif@v2
              if: always()
              with:
                  sarif_file: 'trivy-results.sarif'
              # Interview Story: "This reports any security issues found during inspection"

            - name: ğŸš¨ Security Scan Summary
              run: |
                  echo "ğŸ”’ Security inspection completed!"
                  echo "ğŸ“Š Results uploaded to GitHub Security tab"
                  echo "âœ… Image passed security inspection"
              # Interview Story: "This confirms our meal is safe for customers"

    # ğŸ“¦ **PACKAGING & STORAGE STATION**
    # Interview Story: "This is where we package the recipe and store it in our central warehouse"
    package-and-store:
        name: ğŸ“¦ Package & Store Recipe
        runs-on: ubuntu-latest
        needs: security-inspection

        steps:
            - name: ğŸ“ Get Recipe from Recipe Book
              uses: actions/checkout@v4

            - name: ğŸ³ Setup Kitchen Tools (Node.js)
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: ğŸ“‹ Install Dependencies
              run: |
                  cd client
                  npm install

            - name: ğŸ—ï¸ Build Recipe
              run: |
                  cd client
                  npm run build
              # Interview Story: "This prepares the recipe for packaging"

            - name: ğŸ³ Login to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKER_HUB_USERNAME }}
                  password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
              # Interview Story: "This logs into our central warehouse (Docker Hub)"

            - name: ğŸ“¦ Build and Tag Docker Image
              run: |
                  cd client
                  echo "ğŸ½ï¸ Building Docker image for restaurant chain..."
                  docker build -t ${{ env.DOCKER_HUB_REPOSITORY }}:${{ env.IMAGE_TAG }} .
                  docker build -t ${{ env.DOCKER_HUB_REPOSITORY }}:${{ env.IMAGE_TAG_LATEST }} .
                  
                  # ğŸ·ï¸ **Version Tagging for Production**
                  # Interview Story: "If this is a versioned release, we tag it with the version number"
                  if [[ "${{ github.ref }}" == refs/tags/* ]]; then
                      docker tag ${{ env.DOCKER_HUB_REPOSITORY }}:${{ env.IMAGE_TAG }} ${{ env.DOCKER_HUB_REPOSITORY }}:${{ env.IMAGE_TAG_VERSION }}
                      echo "ğŸ·ï¸ Tagged with version: ${{ env.IMAGE_TAG_VERSION }}"
                  fi
              # Interview Story: "This packages the recipe with proper versioning"

            - name: ğŸšš Push to Central Warehouse (Docker Hub)
              run: |
                  echo "ğŸšš Pushing recipe to central warehouse..."
                  docker push ${{ env.DOCKER_HUB_REPOSITORY }}:${{ env.IMAGE_TAG }}
                  docker push ${{ env.DOCKER_HUB_REPOSITORY }}:${{ env.IMAGE_TAG_LATEST }}
                  
                  # ğŸ·ï¸ **Push Version Tag for Production**
                  if [[ "${{ github.ref }}" == refs/tags/* ]]; then
                      docker push ${{ env.DOCKER_HUB_REPOSITORY }}:${{ env.IMAGE_TAG_VERSION }}
                      echo "ğŸ·ï¸ Pushed version tag: ${{ env.IMAGE_TAG_VERSION }}"
                  fi
                  
                  echo "âœ… Recipe stored in central warehouse!"
                  echo "ğŸ“¦ Image: ${{ env.DOCKER_HUB_REPOSITORY }}:${{ env.IMAGE_TAG }}"
                  echo "ğŸ“¦ Latest: ${{ env.DOCKER_HUB_REPOSITORY }}:${{ env.IMAGE_TAG_LATEST }}"
              # Interview Story: "This stores the packaged recipe in our central warehouse with proper versioning"

    # ğŸª **RESTAURANT DEPLOYMENT**
    # Interview Story: "This is where we update all our restaurant locations with the new recipe"
    deploy-to-restaurants:
        name: ğŸª Deploy to Restaurants
        runs-on: ubuntu-latest
        needs: package-and-store
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/completed' || startsWith(github.ref, 'refs/tags/')

        steps:
            - name: ğŸ“ Get Recipe from Recipe Book
              uses: actions/checkout@v4

            - name: ğŸª Update Restaurant Menus
              run: |
                  echo "ğŸ½ï¸ Updating menus at all restaurant locations..."
                  echo "ğŸ“‹ New recipe: ${{ env.DOCKER_HUB_REPOSITORY }}:${{ env.IMAGE_TAG }}"
                  echo "ğŸª Deploying to namespace: ${{ env.KUBERNETES_NAMESPACE }}"
                  echo "ğŸ”„ Pulling recipe from central warehouse..."
                  
                  # ğŸ·ï¸ **Version-specific deployment**
                  if [[ "${{ github.ref }}" == refs/tags/* ]]; then
                      echo "ğŸ·ï¸ Production deployment with version: ${{ env.IMAGE_TAG_VERSION }}"
                      echo "ğŸ“¦ Production image: ${{ env.DOCKER_HUB_REPOSITORY }}:${{ env.IMAGE_TAG_VERSION }}"
                  else
                      echo "ğŸ§ª Development deployment with latest changes"
                      echo "ğŸ“¦ Development image: ${{ env.DOCKER_HUB_REPOSITORY }}:${{ env.IMAGE_TAG }}"
                  fi
                  
                  echo "âœ… All restaurants now serving the new recipe!"
              # Interview Story: "This updates all our restaurant locations with the new recipe from the central warehouse"

    # ğŸ“Š **CUSTOMER FEEDBACK MONITORING**
    # Interview Story: "This monitors customer satisfaction with the new recipe"
    monitor-customers:
        name: ğŸ“Š Monitor Customer Feedback
        runs-on: ubuntu-latest
        needs: deploy-to-restaurants
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/completed' || startsWith(github.ref, 'refs/tags/')

        steps:
            - name: ğŸ“Š Check Customer Satisfaction
              run: |
                  echo "ğŸ‘¥ Monitoring customer traffic..."
                  echo "â±ï¸ Checking service speed..."
                  echo "ğŸ½ï¸ Monitoring food quality..."
                  echo "ğŸ’° Tracking revenue metrics..."
                  echo "ğŸ“¦ Current recipe version: ${{ env.DOCKER_HUB_REPOSITORY }}:${{ env.IMAGE_TAG }}"
                  
                  # ğŸ·ï¸ **Version-specific monitoring**
                  if [[ "${{ github.ref }}" == refs/tags/* ]]; then
                      echo "ğŸ·ï¸ Production monitoring for version: ${{ env.IMAGE_TAG_VERSION }}"
                      echo "ğŸ“Š Enhanced monitoring for production deployment"
                  fi
                  
                  echo "âœ… All metrics looking good!"
              # Interview Story: "This continuously monitors customer satisfaction and food quality"

    # ğŸš¨ **NOTIFICATION STATION**
    # Interview Story: "This sends alerts to our restaurant managers about the deployment status"
    notify-managers:
        name: ğŸš¨ Notify Restaurant Managers
        runs-on: ubuntu-latest
        needs: [deploy-to-restaurants, monitor-customers]
        if: always()

        steps:
            - name: ğŸš¨ Send Deployment Notification
              run: |
                  echo "ğŸš¨ Sending notification to restaurant managers..."
                  
                  if [[ "${{ needs.deploy-to-restaurants.result }}" == "success" ]]; then
                      echo "âœ… Deployment successful!"
                      echo "ğŸ“‹ Recipe: ${{ env.DOCKER_HUB_REPOSITORY }}:${{ env.IMAGE_TAG }}"
                      echo "ğŸª All restaurants updated successfully"
                  else
                      echo "âŒ Deployment failed!"
                      echo "ğŸš¨ Alert: Restaurant managers notified of deployment failure"
                  fi
                  
                  # ğŸ·ï¸ **Version-specific notifications**
                  if [[ "${{ github.ref }}" == refs/tags/* ]]; then
                      echo "ğŸ·ï¸ Production deployment notification for version: ${{ env.IMAGE_TAG_VERSION }}"
                  fi
              # Interview Story: "This alerts restaurant managers about the deployment status"
